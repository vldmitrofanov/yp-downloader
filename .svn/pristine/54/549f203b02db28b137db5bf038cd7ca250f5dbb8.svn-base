<?php
session_start();
require_once 'main.php';
$db = DB1::getInstance();
$db2 = DB2::getInstance();
if ( empty($_SESSION['level']) || $_SESSION['level'] < 4 ){
    header ('Location: login.php', true, 302);
    exit();
}
$cabinet_content ="";
foreach ($_SESSION as $key=>$value){
      $cabinet_content .= '$_SESSION '.$key." = ".$value."<br />";
      } 
foreach ($_POST as $key=>$value){
      $cabinet_content .= '$_POST '.$key." = ".$value."<br />";
      }   
foreach ($_COOKIE as $key=>$value){
      $cabinet_content .= '$_COOKIE '.$key." = ".$value."<br />";
      }   
$cabinet_content .= "username is ".$_SESSION['user'];
cabinet_html_head("YP GRABBER Dashboard","Yellow Pages","YP GRABBER Dashboard","");
cabinet_header("show_YP_predict_search");
if ( !empty($_GET['action'])){
    cabinet_content_top();
    switch ($_GET['action']){
        case "prepare_request":
            define('INCLUDING',true);
            echo "<h3>Selecting area and directory</h3>";
            include 'prepare_request.php';
            break;
        case "usaBuz":
            //show_YP_predict_search();
            $USAbus_cont = "<h2>USA Business Directory</h2>";
            $USAbus_cont .= "<a href=\"dashboard.php?action=prepare_request\">Load Business LEADS from YP</a><br /><br />";
            $USAbus_cont .= "<a href=\"multiselect_request.php\">Bulk Load Business LEADS from YP 
                </a> (Select multiple city and industries and enqueue your request).<br /><br />";
            $USAbus_cont .= "<a href=\"request_byZipUSAbiz.php\">Bulk load Business LEADS by zipcode list from YP</a><br /><br />";
            $USAbus_cont .= "<h4>Database</h4>";
            $USAbus_cont .= "<a href=\"dashboard.php?action=delete_duplicates\">Delete duplicate entries from Leads Database</a><br /><br />";
            echo $USAbus_cont;
            echo "<a href=\"dashboard.php?action=show_unfinished_queues\">Show inactive queues</a> <br />";
            break;
        case "show_unfinished_queues":
            $sql = "SELECT * FROM `YP_US_industry_done` 
                WHERE `is_finished`='no' AND `enqueued`='no' 
                AND `date_done`> SUBDATE(now(),30) AND `date_done`< SUBDATE(now(), INTERVAL '360' MINUTE)";
            $result = $db->query($sql);
                    if (!$result)  { 
                            printf("[%d] %s\n", $db->errno, $db->error); 
                            exit();
                    }
            if ( $result->num_rows==0 ) {
                    echo "There no any inactive queues <br /><br />";
                    echo "<input type=\"button\" value=\"Back\" onclick=\"goBack()\">";
                } 
            else {
                while($row = $result->fetch_array())
                    $rows[] = $row;
                foreach($rows as $row){
                    $short_url = substr($row['url'],27,strlen($row['url']));
                    echo "Queue ID: ".$row['record_id'].", Pages loaded: ".$row['pages_done'].", URL: ..".$short_url." 
                        <a href=\"dashboard.php?action=requeue&id=".$row['record_id']."\">Activate</a> 
                            <a href=\"dashboard.php?action=delqueue&id=".$row['record_id']."\">Delete</a><br />";
                    }
            }
            break;
            case "requeue":
                if (!empty($_GET['id']) && preg_match("/^[0-9]{1,}$/", $_GET['id'])){
                    $sql = "UPDATE `YP_US_industry_done` SET `enqueued`='yes' WHERE `record_id`='{$_GET['id']}'";
                    $result = $db->query($sql);
                    if (!$result)  { 
                            printf("[%d] %s\n", $db->errno, $db->error); 
                            exit();
                    }
                    else{
                        echo "Sucessfuly!!<br /><br />";
                        echo "<input type=\"button\" value=\"Back\" onclick=\"goBack()\">";
                    }              
                }
                else{
                     exit("ID is not valid");
                 }
            break;
            case "delete_duplicates":
                $LeadsLoaderUSA = new LeadsLoaderUSA();
                $DeleteDuplicates = $LeadsLoaderUSA->DeleteDuplicates($db2);
                echo "Found ".$DeleteDuplicates." duplicates";
            break;
        default:
            echo "i не равно 0, 1 или 2";
    }
    cabinet_content_bottom();
}
else{
cabinet_content($cabinet_content);
}
cabinet_sidebar();
cabinet_footer();
$db->close();
$db2->close();
?>