<?php
// request_byZipUSAbiz.php
//SELECT  primary_city, state,zip,estimated_population FROM `usa_zip_codes`
//where zip in ('10025') and `estimated_population`>'10000' group by primary_city
session_start();
require_once 'main.php';
$db = DB1::getInstance();
$CityStateUSA = new CityStateUSA();
$IndustryUSA = new IndustryUSA();

if ( empty($_SESSION['level']) || $_SESSION['level'] < 4 ){
    header ('Location: login.php', true, 302);
    exit();
}
cabinet_html_head("YP GRABBER Dashboard","Yellow Pages","YP GRABBER Dashboard","");
cabinet_header("");
cabinet_content_top();
if (!empty($_POST['zip'])){
    $_POST['zip'] = trim($_POST['zip']);
    if (preg_match("/^[0-9]{5}$/",$_POST['zip'])){
        $string = "'".$_POST['zip']."'";
        echo $string;
        exit();
    }
    else{
        if (preg_match("/[0-9]{5} [0-9]{5}/",$_POST['zip'])){
            $separator = " ";
        }
        elseif (preg_match("/[0-9]{5}\r[0-9]{5}/",$_POST['zip'])){
            $separator = "\r";
        }
        elseif (preg_match("/[0-9]{5}\n[0-9]{5}/",$_POST['zip'])){
            $separator = "\n";
        }
        elseif (preg_match("/[0-9]{5}\r\n[0-9]{5}/",$_POST['zip'])){
            $separator = "\r\n";
        }
        elseif (preg_match("/[0-9]{5},[0-9]{5}/",$_POST['zip'])){
            $separator = ",";
        }
        elseif (preg_match("/[0-9]{5};[0-9]{5}/",$_POST['zip'])){
            $separator = ";";
        }
        elseif (preg_match("/[0-9]{5}:[0-9]{5}/",$_POST['zip'])){
            $separator = ":";
        }
        if (empty($separator) ){
            exit("ERROR: wrong characters detected<br>");
        }
        $array = explode($separator,$_POST['zip']);
        //print_r($array);
        $string = "";
        foreach ($array as $value){
            $string .="'".$value."',";
        }
        $ziplist = trim($string,",");
        $sql = "SELECT DISTINCT `state` from `usa_zip_codes` WHERE `zip` in ({$ziplist}) ORDER BY `state` ASC";
        $result = $db->query($sql);
        if (!$result)  { printf("[%d] %s\n", $db->errno, $db->error); exit();}
        if ( $result->num_rows > 0 ) {
            while($row = $result->fetch_assoc()){
                 $StateArr[] = $row;
            }
            print_r($StateArr);
            $result->free();
            $statecounter = 0;
            foreach ( $StateArr as $row ){
                echo "<h3>".$row['state']."</h3>";
                echo "Select cities, you want add to query<br />";
                $sql = "SELECT * from `usa_zip_codes` WHERE `zip` in ({$ziplist}) AND `state`='".$row['state']."' GROUP BY `usa_zip_codes`.`primary_city` ASC";
                $result = $db->query($sql);
                if (!$result)  { printf("[%d] %s\n", $db->errno, $db->error); exit();}
                //$ResultArr = array();                
//                    while($row = $result->fetch_assoc()){
//                        $ResultArr[] = $row;
//                    }           
                    echo "<form method=\"post\">";
                    echo "<script language=\"JavaScript\">
                            function toggle".$statecounter."(source) {
                            checkboxes".$statecounter." = document.getElementsByName('city".$statecounter."[]');
                            for(var i=0, n=checkboxes".$statecounter.".length;i<n;i++) {
                            checkboxes".$statecounter."[i].checked = source.checked;
                             }
                           }
                           </script> \n";
                    echo "<table id=\"citymultiselect\">\n";
                    echo "<tr><th colspan=\"2\">City</th><th>Zip</th><th>County</th></tr>\n";
                    //$count = 0;
                    while($row2 = $result->fetch_assoc()) {
                        //$outputTr = ($count % 3) == 0;
                        //if($outputTr) echo '<tr>';
                        echo "<tr>\n";
                        echo "<td><input type=\"checkbox\" name=\"city".$statecounter."[]\" value=\"".$row2['primary_city']."\"/> </td><td>".$row2['primary_city']." </td>";
                        echo"<td>".$row2['zip']."</td>";
                        echo"<td>".$row2['county']."</td>";
                        echo "</tr>\n";
                        //if($outputTr) echo '</tr>';
                        //$count++;
                    }
                echo "</table>";
                echo "<input type=\"checkbox\" onClick=\"toggle".$statecounter."(this)\" /> <b>Toggle All</b> <br/>\n";
                echo "<input type=\"hidden\" name=\"state\" value=\"".$row['state']."\">\n";
                echo "<input type=\"submit\" value=\"Submit\">\n";
                echo "</form><br>\n";
                $statecounter++;
                $result->free();
                //print_r($ResultArr);
            }
        }
        //cabinet_footer();
        exit();
        }
    }
?>
<form method="post">
    <textarea name='zip'></textarea>
    <input type="submit">
    </form>
<?php
//cabinet_footer();
$db->close();
?>